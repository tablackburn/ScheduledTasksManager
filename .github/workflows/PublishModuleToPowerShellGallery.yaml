name: Publish Module to PowerShell Gallery

on:
  push:
    branches:
      - main
    paths:
      - 'ScheduledTasksManager/ScheduledTasksManager.psd1'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    name: Publish Module
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get Module Version
        id: version
        run: |
          $manifest = Import-PowerShellDataFile -Path ./ScheduledTasksManager/ScheduledTasksManager.psd1
          $version = $manifest.ModuleVersion
          Write-Host "Module version: $version"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Check if Release Exists
        id: check_release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Bootstrap
        if: steps.check_release.outputs.exists == 'false'
        run: ./build.ps1 -Task 'Init' -Bootstrap

      - name: Check if Version Exists in PSGallery
        id: check_psgallery
        if: steps.check_release.outputs.exists == 'false'
        run: |
          Import-Module BuildHelpers
          Set-BuildEnvironment -Force
          [version]$githubVersion = Get-Metadata -Path $env:BHPSModuleManifest -PropertyName 'ModuleVersion' -ErrorAction 'Stop'
          $moduleSplat = @{
              Repository      = 'PSGallery'
              Name            = $env:BHProjectName
              RequiredVersion = $githubVersion
              AllowPrerelease = $True
              ErrorAction     = 'SilentlyContinue'
          }
          if (Find-Module @moduleSplat) {
              $inGallery = $True
          }
          else {
              $inGallery = $False
          }
          Add-Content -LiteralPath $env:GITHUB_OUTPUT -Value "IN_GALLERY=$inGallery" -Confirm:$False -Encoding 'UTF8'

      - name: Create GitHub Release
        if: steps.check_release.outputs.exists == 'false'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            --title "v${{ steps.version.outputs.version }}" \
            --generate-notes

      - name: Publish to PSGallery
        if: steps.check_release.outputs.exists == 'false' && steps.check_psgallery.outputs.IN_GALLERY == 'False'
        env:
          PSGALLERY_API_KEY: ${{ secrets.PS_GALLERY_KEY }}
        run: ./build.ps1 -Task 'Publish' -Bootstrap
